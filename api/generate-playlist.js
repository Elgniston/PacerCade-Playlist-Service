const BASE_URL = "https://api.spotify.com/v1";

async function spotifyFetch(token, url, options = {}) {
  const response = await fetch(url, {
    ...options,
    headers: {
      Authorization: `Bearer ${token}`,
      "Content-Type": "application/json",
      ...(options.headers || {}),
    },
  });
  if (!response.ok) {
    const text = await response.text();
    throw new Error(`${response.status} ${response.statusText}: ${text}`);
  }
  return response.json();
}

export default async function handler(req, res) {
  if (req.method !== "POST") {
    res.status(405).json({ error: "Method not allowed" });
    return;
  }

  const { bpm, seedQuery = "running", trackCount = 20 } = req.body || {};
  const authHeader = req.headers.authorization || "";
  const token = authHeader.replace("Bearer ", "");

  if (!token) {
    res.status(401).json({ error: "Missing Spotify access token" });
    return;
  }

  if (!bpm || Number.isNaN(Number(bpm))) {
    res.status(400).json({ error: "Invalid BPM value" });
    return;
  }

  try {
    const me = await spotifyFetch(token, `${BASE_URL}/me`);

    const searchResults = await spotifyFetch(
      token,
      `${BASE_URL}/search?${new URLSearchParams({
        q: seedQuery,
        type: "track",
        limit: "50",
      })}`
    );

    const trackItems = searchResults.tracks?.items || [];
    const trackIds = trackItems.map((track) => track.id).join(",");

    const audioFeatures = await spotifyFetch(
      token,
      `${BASE_URL}/audio-features?ids=${trackIds}`
    );

    const tolerance = 3;
    const targetBpm = Number(bpm);

    const matchedTracks = trackItems.filter((track, index) => {
      const tempo = audioFeatures.audio_features?.[index]?.tempo;
      return tempo && Math.abs(tempo - targetBpm) <= tolerance;
    });

    if (matchedTracks.length === 0) {
      res.status(404).json({ error: "No tracks found for this BPM" });
      return;
    }

    const playlist = await spotifyFetch(token, `${BASE_URL}/users/${me.id}/playlists`, {
      method: "POST",
      body: JSON.stringify({
        name: `Pacercade ${targetBpm} BPM`,
        description: "Generated by Pacercade",
        public: false,
      }),
    });

    const selectedTracks = matchedTracks.slice(0, trackCount);
    const uris = selectedTracks.map((track) => track.uri);

    await spotifyFetch(
      token,
      `${BASE_URL}/playlists/${playlist.id}/tracks`,
      {
        method: "POST",
        body: JSON.stringify({ uris }),
      }
    );

    res.status(200).json({
      playlistId: playlist.id,
      playlistUrl: playlist.external_urls?.spotify,
      trackCount: selectedTracks.length,
      targetBpm,
    });
  } catch (err) {
    res.status(500).json({ error: "Failed to create playlist", details: err.message });
  }
}
